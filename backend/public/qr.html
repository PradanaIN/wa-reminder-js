<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Scan QR WhatsApp</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; background: #0b1220; color: #e5e7eb; margin: 0; padding: 24px; }
      .wrap { max-width: 520px; margin: 0 auto; }
      .card { background: rgba(2,6,23,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; }
      h1 { font-size: 20px; margin: 0 0 12px; }
      p { margin: 8px 0; color: #94a3b8; }
      .qr-box { display: grid; place-items: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; }
      .qr-box img { width: 280px; height: 280px; image-rendering: pixelated; }
      .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
      .muted { color: #9ca3af; font-size: 12px; }
      button { background: #2563eb; color: white; border: 0; border-radius: 8px; padding: 8px 12px; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: default; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Scan QR WhatsApp</h1>
        <p>Gunakan WhatsApp di ponsel Anda: Menu → Perangkat Tertaut → <em>Tautkan Perangkat</em>, lalu pindai QR di bawah ini.</p>
        <div id="state" class="muted">Memeriksa ketersediaan QR…</div>
        <div class="qr-box" id="qrBox" style="display:none">
          <img id="qrImg" alt="QR Code" />
        </div>
        <div class="row" style="margin-top:12px">
          <button id="refreshBtn">Muat ulang</button>
          <span class="muted">QR otomatis diperbarui setiap 15 detik</span>
        </div>
      </div>
    </div>

    <script>
      const stateEl = document.getElementById('state');
      const boxEl = document.getElementById('qrBox');
      const imgEl = document.getElementById('qrImg');
      const btn = document.getElementById('refreshBtn');
      let timer = null;

      async function refresh() {
        try {
          btn.disabled = true;
          stateEl.textContent = 'Memeriksa ketersediaan QR…';
          const res = await fetch('/api/system/qr');
          if (!res.ok) throw new Error('Gagal memuat QR');
          const data = await res.json();
          if (data && data.qr) {
            // Load SVG generated by server; cache-bust with ts param
            imgEl.src = '/api/system/qr.svg?ts=' + Date.now();
            boxEl.style.display = '';
            stateEl.textContent = 'QR tersedia. Silakan pindai.';
          } else {
            boxEl.style.display = 'none';
            stateEl.textContent = 'QR belum tersedia. Pastikan bot sedang menunggu pemindaian.';
          }
        } catch (e) {
          boxEl.style.display = 'none';
          stateEl.textContent = 'Terjadi kesalahan memuat QR.';
          console.error(e);
        } finally {
          btn.disabled = false;
        }
      }

      btn.addEventListener('click', refresh);
      refresh();
      timer = setInterval(refresh, 15000);
      window.addEventListener('beforeunload', () => timer && clearInterval(timer));
    </script>
  </body>
  </html>

